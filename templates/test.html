{% extends "base.html" %}
{% block titulo %}{{ test.name }} · Tests Académicos{% endblock %}

{% block contenido %}
<section class="container form-wrap">
  <h1 class="section-title">{{ test.name }}</h1>
  <p class="section-subtitle">
    Escala Likert {{ test.likert_min }}–{{ test.likert_max }}.
    {% if test.description %}{{ test.description }}{% endif %}
  </p>

  <!-- LEYENDA / INSTRUCCIONES -->
  <ul class="likert-key card" role="list" aria-label="Guía de la escala Likert">
    <li>
      <span class="label">Nunca</span>
      <span class="num">1</span>
      <span class="pct">0% de las veces</span>
    </li>
    <li>
      <span class="label">Rara vez</span>
      <span class="num">2</span>
      <span class="pct">25% de las veces</span>
    </li>
    <li>
      <span class="label">A veces</span>
      <span class="num">3</span>
      <span class="pct">50% de las veces</span>
    </li>
    <li>
      <span class="label">Frecuentemente</span>
      <span class="num">4</span>
      <span class="pct">75% de las veces</span>
    </li>
    <li>
      <span class="label">Siempre</span>
      <span class="num">5</span>
      <span class="pct">100% de las veces</span>
    </li>
  </ul>

  <!-- PROGRESO -->
  <div class="progress-wrap">
    <div class="progress" aria-label="Progreso">
      <div id="progressFill"></div>
    </div>
    <span id="progressChip" class="progress-chip">0 / {{ test.questions|length }} completadas</span>
  </div>

  <!-- El formulario postea a /test/<code> (tu vista ya lo espera) -->
  <form id="form-test"
        action="{{ url_for('test_run', test_code=test.code) }}"
        method="post"
        class="card form-card">

    {% for sec in (test.sections | sort(attribute='order')) %}
      {% set qs = (test.questions
                   | selectattr('section_id', 'equalto', sec.id)
                   | sort(attribute='order')) %}
      {% if qs|length > 0 %}
        <h2 class="group-title">{{ sec.title }}</h2>
        <div class="likert-group">
          {% for q in qs %}
            <div class="likert-question" {% if q.reversed %}data-reverse="1"{% endif %}>
              <div class="qtext">{{ q.number }}. {{ q.text }}</div>
              <div class="likert-options">
                {% for i in range(test.likert_min, test.likert_max + 1) %}
                  <label class="opt" title="{{ i }}">
                    <input type="radio" name="q{{ q.number }}" value="{{ i }}" required>
                    <span>{{ i }}</span>
                  </label>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}

    <br>
    <div class="actions">
      <button id="submitBtn" class="btn btn--primary btn--full" type="submit" disabled>
        Enviar respuestas
      </button>
      <br>
      <p id="pendingMsg" class="pending-hint" aria-live="polite" style="margin-top:.35rem;"></p>
    </div>
  </form>
</section>

<!-- Script: progreso y habilitar submit dinámicamente -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('form-test');
  const submitBtn = document.getElementById('submitBtn');
  const pendingMsg = document.getElementById('pendingMsg');
  const fill = document.getElementById('progressFill');
  const chip = document.getElementById('progressChip');

  const allNames = Array.from(form.querySelectorAll('input[type="radio"]'))
    .reduce((set, el) => set.add(el.name), new Set());
  const total = allNames.size;

  function updateState() {
    const answered = new Set(
      Array.from(form.querySelectorAll('input[type="radio"]:checked')).map(el => el.name)
    );
    const done = answered.size;
    const remaining = total - done;
    const pct = Math.round((done / total) * 100);

    submitBtn.disabled = remaining > 0;
    pendingMsg.textContent = remaining > 0
      ? `Te faltan ${remaining} pregunta${remaining === 1 ? '' : 's'} por responder.`
      : '¡Listo! Puedes enviar tus respuestas.';

    if (fill) fill.style.width = pct + '%';
    if (chip) chip.textContent = `${done} / ${total} completadas`;
  }

  form.addEventListener('change', updateState);
  updateState();
});
</script>
{% endblock %}
