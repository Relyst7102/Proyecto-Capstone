{% extends "base.html" %}
{% block titulo %}Resultado · {{ session.test.name }}{% endblock %}

{% block contenido %}
<section class="container form-wrap">
  <h1 class="section-title">Resultado · {{ session.test.name }}</h1>
  <p class="section-subtitle">Puntaje bruto según la escala Likert del instrumento.</p>

  {# ===== Cálculos seguros en plantilla ===== #}
  {% set num_items  = session.test.questions|length %}
  {% set likert_max = session.test.likert_max or 5 %}
  {% set total_max  = num_items * likert_max %}

  {# score_total puede ser NULL; si lo es, sumamos las respuestas #}
  {% set total_calc = session.score_total if session.score_total is not none
                      else (session.responses | map(attribute='value') | sum) %}
  {% set total_pct  = (total_calc * 100 // (total_max if total_max else 1)) %}

  <div class="result-grid">

    <!-- KPI principal -->
    <div class="card result-card">
      <div class="kpi">
        <div class="total">{{ total_calc }}</div>
        <div>
          <div><strong>Puntaje total</strong></div>
          <small>máx. {{ total_max }} • {{ total_pct }}%</small>
        </div>
      </div>

      <div class="result-cta">
        {% if request.args.get('from') == 'tests' %}
          <a class="btn btn--primary" href="{{ url_for('perfil_tests') }}">Volver a mis tests</a>
        {% else %}
          <a class="btn btn--primary" href="{{ url_for('inicio') }}">Volver al inicio</a>
        {% endif %}
      </div>

      <hr style="margin: 1rem 0; border:none; border-top:1px solid var(--border)">
      <p style="color:var(--muted); margin:0">
        <strong>Participante:</strong> (Participante {{ participant.id }}) — anonimo@gmail.com<br>
        <strong>Fecha:</strong> {{ session.completed_at or session.started_at }}
      </p>

      <p class="pending-hint" style="margin:.8rem 0 0 0;">
        Nota: es un puntaje bruto (aún sin inversión de ítems ni clasificación). Se añadirá más adelante.
      </p>
    </div>

    <!-- Respuestas -->
    <div class="card result-card">
      <h3 style="margin:0 0 .75rem 0;">Tus respuestas</h3>

      <div class="likert-group" style="gap:.5rem;">
        {# Ordenamos por número de pregunta #}
        {% for r in session.responses | sort(attribute='question.number') %}
          <div class="likert-question">
            <div class="qtext">
              <span style="opacity:.8; margin-right:.35rem;">{{ r.question.number }}.</span>
              {{ r.question.text }}
              {% if r.question.reversed %}
                <small class="pending-hint">(ítem invertido)</small>
              {% endif %}
            </div>
            <div class="likert-options" aria-label="Respuesta marcada">
              <span class="num" style="min-width:2rem; text-align:center;">{{ r.value }}</span>
            </div>
          </div>
        {% else %}
          <p class="pending-hint">No se encontraron respuestas registradas en esta sesión.</p>
        {% endfor %}
      </div>
    </div>

  </div>
</section>
{% endblock %}
